# 智能查询系统架构

## 系统概述

智能查询系统是一个基于自然语言的学术知识图谱查询平台，将复杂的MCP工具、数据库操作和AI能力对用户隐藏，提供简洁易用的查询接口。

## 架构设计原则

1. **用户友好**: 用户只需要输入自然语言，无需了解技术细节
2. **智能路由**: 系统自动分析查询意图并执行相应操作
3. **模块化设计**: 各服务职责清晰，便于维护和扩展
4. **可扩展性**: 支持新的查询类型和分析功能

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层                                │
├─────────────────────────────────────────────────────────────────┤
│  IntelligentQueryController  │  用户认证  │  查询历史  │  系统状态  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      智能查询服务层                              │
├─────────────────────────────────────────────────────────────────┤
│              IntelligentQueryService                            │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐    │
│  │ 意图分析路由    │ │ 查询执行引擎    │ │ 结果整合器      │    │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  自然语言处理   │ │   图谱分析      │ │   数据可视化    │
│ NaturalLanguage │ │ GraphAnalysis   │ │ ChartGeneration │
│   Processor     │ │    Service      │ │    Service      │
└─────────────────┘ └─────────────────┘ └─────────────────┘
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   LLM服务       │ │   Neo4j数据库   │ │   图表生成器    │
│ MockLLMService  │ │  (知识图谱)     │ │  (Cytoscape.js) │
└─────────────────┘ └─────────────────┘ └─────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据层 (隐藏层)                            │
├─────────────────────────────────────────────────────────────────┤
│  MongoDB     │  MySQL      │  Redis      │  Chroma        │ MCP  │
│  (论文数据)  │  (用户日志)  │  (缓存)     │  (向量存储)    │ 工具  │
└─────────────────────────────────────────────────────────────────┘
```

## 核心服务详解

### 1. IntelligentQueryService (智能查询服务)

**职责**: 系统核心服务，负责协调各个子服务

**主要功能**:
- 接收用户自然语言查询
- 分析查询意图
- 路由到相应的处理服务
- 整合查询结果
- 返回综合响应

**关键方法**:
```java
public ApiResponseDTO<IntelligentQueryResponseDTO> intelligentQuery(String query, String userId)
```

### 2. NaturalLanguageProcessor (自然语言处理器)

**职责**: 处理自然语言理解和生成

**主要功能**:
- 分析查询意图 (GRAPH_QUERY, DATA_ANALYSIS, LITERATURE_REVIEW等)
- 生成Cypher查询语句
- 生成分析报告
- 生成文献综述

**关键方法**:
```java
public QueryIntent analyzeIntent(String query)
public String generateCypherQuery(QueryIntent intent)
public String generateAnalysisReport(QueryIntent intent, List<Map<String, Object>> results)
```

### 3. GraphAnalysisService (图谱分析服务)

**职责**: 执行图谱查询和数据分析

**主要功能**:
- 执行Cypher查询
- 获取分析数据
- 获取文献数据
- 获取趋势数据

**关键方法**:
```java
public List<Map<String, Object>> queryGraph(String cypherQuery)
public List<Map<String, Object>> getAnalysisData(QueryIntent intent)
```

### 4. ChartGenerationService (图表生成服务)

**职责**: 生成各种可视化图表

**主要功能**:
- 生成图谱可视化数据
- 生成分析图表 (柱状图、饼图、折线图等)
- 生成趋势图表
- 生成作者合作网络

**关键方法**:
```java
public Map<String, Object> generateGraphVisualization(List<Map<String, Object>> graphResults)
public Map<String, Object> generateAnalysisCharts(List<Map<String, Object>> data, QueryIntent intent)
```

### 5. DataCrawlingService (数据爬取服务)

**职责**: 根据查询意图智能爬取数据

**主要功能**:
- 分析爬取需求
- 选择合适的数据源 (arXiv, CNKI)
- 执行异步爬取任务
- 处理爬取结果

## 查询流程

### 1. 查询接收
```
用户输入自然语言 → IntelligentQueryController → IntelligentQueryService
```

### 2. 意图分析
```
NaturalLanguageProcessor.analyzeIntent() → 返回QueryIntent对象
```

### 3. 查询路由
```
根据QueryIntent.type路由到相应的处理方法:
- GRAPH_QUERY → executeGraphQuery()
- DATA_ANALYSIS → executeDataAnalysis()
- LITERATURE_REVIEW → executeLiteratureReview()
- TREND_ANALYSIS → executeTrendAnalysis()
- CRAWL_DATA → executeDataCrawling()
```

### 4. 结果整合
```
各服务返回结果 → IntelligentQueryService整合 → 返回IntelligentQueryResponseDTO
```

## 数据流

### 图谱查询流程
```
自然语言 → 意图分析 → Cypher生成 → Neo4j查询 → 图谱数据 → 可视化生成 → 返回结果
```

### 数据分析流程
```
自然语言 → 意图分析 → 数据查询 → 统计分析 → 图表生成 → 分析报告 → 返回结果
```

### 文献综述流程
```
自然语言 → 意图分析 → 文献查询 → 内容分析 → 综述生成 → 趋势图表 → 返回结果
```

## 技术栈

### 后端技术
- **Spring Boot**: 主框架
- **Spring Security**: 安全认证
- **Spring Data**: 数据访问
- **Neo4j**: 图数据库
- **MongoDB**: 文档数据库
- **MySQL**: 关系数据库
- **Redis**: 缓存
- **Chroma**: 向量数据库

### AI技术
- **Spring AI**: LLM集成框架
- **OpenAI GPT**: 大语言模型
- **自然语言处理**: 意图分析、文本生成
- **知识图谱**: 实体抽取、关系抽取

### 前端技术
- **Next.js**: 前端框架
- **Cytoscape.js**: 图谱可视化
- **Chart.js**: 图表生成

## 扩展性设计

### 1. 新查询类型
- 在`QueryIntent.QueryType`中添加新类型
- 在`IntelligentQueryService`中添加对应的处理方法
- 实现相应的业务逻辑

### 2. 新数据源
- 在`DataCrawlingService`中添加新的爬虫服务
- 实现相应的数据接口
- 更新数据路由逻辑

### 3. 新图表类型
- 在`ChartGenerationService`中添加新的图表生成方法
- 实现相应的数据处理逻辑
- 更新前端可视化组件

## 优势

1. **用户友好**: 隐藏技术复杂性，提供自然语言接口
2. **智能化**: 自动分析意图，智能路由查询
3. **可扩展**: 模块化设计，易于添加新功能
4. **高性能**: 异步处理，缓存优化
5. **可视化**: 丰富的图表和可视化功能

## 部署架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Next.js) │    │  后端 (Spring)  │    │   数据库集群    │
│                 │    │                 │    │                 │
│  - 用户界面     │◄──►│  - API服务      │◄──►│  - Neo4j        │
│  - 图谱可视化   │    │  - 智能查询     │    │  - MongoDB      │
│  - 图表展示     │    │  - 数据分析     │    │  - MySQL        │
│                 │    │  - 数据爬取     │    │  - Redis        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

这种架构设计将复杂的底层技术对用户隐藏，提供了简洁易用的自然语言查询接口，同时保持了系统的可扩展性和可维护性。
